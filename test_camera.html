<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .debug-info { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        video { width: 100%; max-width: 640px; border: 2px solid #ccc; }
        button { padding: 10px 20px; margin: 10px 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Camera Debug Test</h1>
        
        <div class="debug-info">
            <h3>Browser Info:</h3>
            <p><strong>User Agent:</strong> <span id="userAgent"></span></p>
            <p><strong>MediaDevices Support:</strong> <span id="mediaDevicesSupport"></span></p>
        </div>

        <div class="debug-info">
            <h3>Available Video Input Devices:</h3>
            <div id="deviceList"></div>
        </div>

        <div class="debug-info">
            <h3>Camera Test:</h3>
            <button onclick="listDevices()">List All Devices</button>
            <button onclick="testCamera()">Test Camera Access</button>
            <button onclick="testSpecificCamera()">Test Specific Camera</button>
            <br><br>
            <video id="video" autoplay muted></video>
        </div>

        <div class="debug-info">
            <h3>Debug Log:</h3>
            <div id="debugLog"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            console.log(`[${timestamp}] ${message}`);
        }

        // Initialize page
        document.getElementById('userAgent').textContent = navigator.userAgent;
        document.getElementById('mediaDevicesSupport').textContent = 
            navigator.mediaDevices ? 'Supported' : 'Not Supported';

        if (!navigator.mediaDevices) {
            log('MediaDevices API not supported!', 'error');
        } else {
            log('MediaDevices API is supported', 'success');
        }

        async function listDevices() {
            try {
                log('Requesting device permissions...');
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                stream.getTracks().forEach(track => track.stop());
                
                log('Getting device list...');
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                log(`Found ${videoDevices.length} video input devices:`, 'success');
                
                const deviceList = document.getElementById('deviceList');
                deviceList.innerHTML = '';
                
                videoDevices.forEach((device, index) => {
                    const deviceDiv = document.createElement('div');
                    deviceDiv.style.margin = '10px 0';
                    deviceDiv.style.padding = '10px';
                    deviceDiv.style.border = '1px solid #ddd';
                    deviceDiv.style.borderRadius = '5px';
                    deviceDiv.innerHTML = `
                        <strong>Device ${index + 1}:</strong><br>
                        <strong>ID:</strong> ${device.deviceId}<br>
                        <strong>Label:</strong> ${device.label || 'No label'}<br>
                        <strong>Group ID:</strong> ${device.groupId || 'No group ID'}<br>
                        <button onclick="testDevice('${device.deviceId}')">Test This Device</button>
                    `;
                    deviceList.appendChild(deviceDiv);
                    log(`Device ${index + 1}: ${device.label || 'Unnamed device'} (${device.deviceId})`);
                });
                
            } catch (error) {
                log(`Error listing devices: ${error.message}`, 'error');
                console.error('Device enumeration error:', error);
            }
        }

        async function testCamera() {
            try {
                log('Testing camera access...');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }, 
                    audio: false 
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                log('Camera access successful!', 'success');
                log(`Stream tracks: ${stream.getTracks().length}`);
                stream.getTracks().forEach(track => {
                    log(`Track: ${track.kind}, enabled: ${track.enabled}, readyState: ${track.readyState}`);
                });
                
            } catch (error) {
                log(`Camera access failed: ${error.message}`, 'error');
                console.error('Camera test error:', error);
            }
        }

        async function testSpecificCamera() {
            try {
                log('Testing specific camera selection...');
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                if (videoDevices.length === 0) {
                    log('No video devices found', 'error');
                    return;
                }
                
                // Try to find our virtual camera by looking for "rust" in the label
                const virtualCamera = videoDevices.find(device => 
                    device.label && device.label.toLowerCase().includes('rust')
                );
                
                const deviceToTest = virtualCamera || videoDevices[0];
                log(`Testing device: ${deviceToTest.label || 'Unnamed device'}`);
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        deviceId: { exact: deviceToTest.deviceId },
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }, 
                    audio: false 
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                log('Specific camera test successful!', 'success');
                
            } catch (error) {
                log(`Specific camera test failed: ${error.message}`, 'error');
                console.error('Specific camera test error:', error);
            }
        }

        async function testDevice(deviceId) {
            try {
                log(`Testing device with ID: ${deviceId}`);
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        deviceId: { exact: deviceId },
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }, 
                    audio: false 
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                log(`Device test successful for: ${deviceId}`, 'success');
                
            } catch (error) {
                log(`Device test failed for ${deviceId}: ${error.message}`, 'error');
                console.error('Device test error:', error);
            }
        }

        // Auto-run device listing on page load
        window.addEventListener('load', () => {
            log('Page loaded, checking for devices...');
            setTimeout(listDevices, 1000);
        });
    </script>
</body>
</html> 